{% extends "base.html" %}
{% block content %}

<div id="vocalist-app">
  <section id="todaySection" class="section today">
    <div class="compact-controls">
      <div id="timerMini" class="timer-mini" aria-live="polite">00:30</div>
      <button id="micMini" class="mic-mini" aria-pressed="false" title="Start/Stop microphone" disabled>🎤</button>
    </div>
    <div class="today-inner">
      <div class="letter" id="letterBubble"></div>
      <div class="theme">
        <div class="label">THEME</div>
        <h1 id="themeHeading" class="value"></h1>
      </div>
    </div>
  </section>

  <section class="section composer">
    <div id="modePill" class="mode-pill" style="display:none">VOICE MODE</div>
    <div id="startPlaceholder" class="placeholder-letter" aria-hidden="true" style="display:none">?</div>
    <input id="typeInput" class="giant-input" type="text" placeholder="" disabled />
    <div id="liveTranscript" class="transcript" style="display:none"></div>
    <div id="tinyHint" class="tiny-hint"></div>
  </section>

  <section id="acceptedSectionAnchor"></section>

  <footer class="bottombar">
    <div class="hint">PRESS START, THEN TYPE OR TAP 🎤 TO SPEAK…</div>
    <div class="actions">
      <button id="startBtn" class="btn btn-primary">START</button>
      <button id="finishBtn" class="btn btn-ghost" style="display:none">FINISH</button>
    </div>
  </footer>

  <dialog id="summaryModal">
    <div class="modal-card">
      <h2>Time’s up</h2>
      <p class="modal-subtle">Here’s how you went this round.</p>
      <div class="stat-grid" id="summaryStats">
        <div><div class="stat-label">LETTER</div><div class="stat-value" id="sumLetter">—</div></div>
        <div><div class="stat-label">THEME</div><div class="stat-value" id="sumTheme">—</div></div>
        <div><div class="stat-label">VALID</div><div class="stat-value" id="sumValid">0</div></div>
        <div><div class="stat-label">OFF THEME</div><div class="stat-value" id="sumOff">0</div></div>
        <div><div class="stat-label">WORDS</div><div class="stat-value" id="sumWords">0</div></div>
        <div><div class="stat-label">DURATION</div><div class="stat-value" id="sumDur">00:00</div></div>
        <div><div class="stat-label">SCORE</div><div class="stat-value" id="sumScore">…</div></div>
        <div><div class="stat-label">BONUS/WORD</div><div class="stat-value" id="sumBonus">+0</div></div>
      </div>
      <div class="summary-words">
        <div class="stat-label" style="margin-bottom:6px">WORDS ENTERED</div>
        <div id="sumWordList" class="wordstream"></div>
      </div>
      <div class="modal-actions" style="margin-top:12px">
        <form method="dialog">
          <button id="closeSummaryBtn" class="btn btn-primary">OK</button>
        </form>
      </div>
    </div>
  </dialog>

  <style>
    :root{ --section-gap:28px; --bg:#FFFFFF; --ink:#1A202C; --ink-2:#4A5568; --card:#FFF; --accent:#0E7C86; --shadow:0 8px 24px rgba(26,32,44,.06); --radius:24px }
    .section{ position:relative; padding:18px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); margin:0 auto var(--section-gap) auto; }
    .today-inner{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center}
    .letter{width:84px;height:84px;border-radius:999px;display:grid;place-items:center;background:var(--accent);color:#fff;font-weight:800;font-size:48px}
    .theme .label{color:var(--ink-2);font-size:12px;letter-spacing:.08em}
    .theme .value{margin:.25rem 0 0;font-size:28px;letter-spacing:.04em}
    .compact-controls{position:absolute;right:14px;top:14px;display:flex;flex-direction:column;align-items:center;gap:6px}
    .timer-mini{min-width:78px;height:34px;padding:0 10px;border-radius:999px;background:#fff;border:1px solid #E2E8F0;display:inline-grid;place-items:center;font-weight:800;font-size:14px;letter-spacing:.06em}
    .mic-mini{width:38px;height:38px;border-radius:999px;border:0;background:#fff;display:inline-grid;place-items:center;font-size:18px;cursor:pointer;box-shadow:var(--shadow)}
    .mic-mini[aria-pressed="false"]{opacity:.9}
    .composer{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;min-height:300px}
    .giant-input{width:100%;max-width:900px;text-align:center;font-size:96px;font-weight:800;color:var(--ink);height:140px;line-height:140px;letter-spacing:.08em;border:0;outline:0;border-radius:16px;text-transform:uppercase;background:#fff;box-shadow:none}
    .placeholder-letter{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:180px;height:180px;border-radius:999px;background:var(--accent);color:#fff;display:grid;place-items:center;font-weight:800;font-size:96px;letter-spacing:.06em;box-shadow:var(--shadow)}
    .transcript{width:100%;max-width:900px;text-align:center;font-size:32px;font-weight:700;color:#222;min-height:40px;letter-spacing:.04em}
    .mode-pill{font-size:12px;color:#0f172a;background:#e2f4f6;border:1px solid #c7ecef;padding:2px 8px;border-radius:999px}
    .tiny-hint{height:0;font-size:12px;color:#C53030;background:transparent;font-weight:700;padding:0 8px;border-radius:999px;opacity:0;transform:translateY(-8px);transition:opacity .2s,transform .2s;margin-top:-8px;text-transform:uppercase}
    .tiny-hint.show{height:auto;opacity:1;transform:translateY(0);margin-top:0}
    .wordstream{display:flex;flex-wrap:wrap;gap:8px;margin:0;padding:2px;list-style:none}
    .wordstream li,.wordstream span{font-weight:700;letter-spacing:.03em;font-size:12px;color:#475569;line-height:1.1;margin:0}
    .wordstream .off-theme{opacity:.6}
    .bottombar{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(255,255,255,0) 0%,rgba(255,255,255,1) 24%,rgba(255,255,255,1) 100%);padding:24px 0;border-top:1px solid #E2E8F0;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .bottombar .hint{font-size:12px;color:var(--ink-2);letter-spacing:.06em}
    .actions{display:flex;gap:10px}
    .stat-grid{margin:10px 0 8px;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width: 720px){ .stat-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .stat-label{font-size:11px;letter-spacing:.08em;color:#64748b}
    .stat-value{font-weight:800;font-size:18px;letter-spacing:.04em}
    .summary-words{margin-top:8px}
  </style>

  <script>
    // --- Tiny auth shim so START works even if base.html didn't define ensureAuth ---
    if (typeof window.ensureAuth !== 'function') {
      window.ensureAuth = async function ensureAuth(options = {}) {
        const force = !!options.force;
        try {
          if (window.sb?.auth?.getSession) {
            const { data:{ session } } = await window.sb.auth.getSession();
            if (session?.access_token) {
              window.__supabase_token = session.access_token; // ensure fetch() wrapper can attach it
              return session;
            }
          }
        } catch (e) { /* ignore */ }
        if (window.__supabase_token) return { access_token: window.__supabase_token };
        if (force) document.getElementById('authDialog')?.showModal();
        return null;
      };
    }

    const state = { voice:false,listening:false,running:false,remaining:60,words:new Set(),onTheme:new Set(),offTheme:new Set(),invalid:0,sr:null,timerId:null,startedAt:null };

    function showStartPlaceholder(show){
      const ph=document.getElementById('startPlaceholder'), ti=document.getElementById('typeInput');
      if(!ph||!ti) return; ph.style.display=show?'grid':'none'; ti.style.visibility=show?'hidden':'visible';
    }
    async function bootPlaceholder(){
      const session = await window.ensureAuth({force:false});
      showStartPlaceholder(!!session && !state.running);
      window.sb?.auth?.onAuthStateChange((_e,sess)=>{ if(!state.running) showStartPlaceholder(!!sess); });
    }
    document.addEventListener('DOMContentLoaded', bootPlaceholder);

    function showTinyHint(msg){ const el=document.getElementById('tinyHint'); el.textContent=String(msg||"").toUpperCase(); el.classList.add("show"); clearTimeout(showTinyHint._t); showTinyHint._t=setTimeout(()=> el.classList.remove("show"), 1200); }
    function setMicVisual(on){ document.getElementById("micMini").setAttribute("aria-pressed", String(on)); }

    async function ensureMicPermission(){ if (!navigator.mediaDevices?.getUserMedia) return true; try { const s = await navigator.mediaDevices.getUserMedia({ audio: true }); s.getTracks().forEach(t=>t.stop()); return true; } catch { return false; } }
    document.getElementById('micMini').addEventListener("click", async ()=>{ if (!state.running) { showTinyHint("PRESS START"); return; } if(!state.voice){ const ok=await ensureMicPermission(); if(!ok) return; } state.voice=!state.voice; if(state.voice) enterVoiceMode(); else exitVoiceMode(); });

    function ensureSpeech(){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) return null; const r=new SR(); r.continuous=true; r.interimResults=true; r.lang="en-AU"; r.onresult=(e)=>{ if (!state.running) return; for (let i=e.resultIndex;i<e.results.length;i++){ const res=e.results[i]; if(!res.isFinal) continue; const t=(res[0]?.transcript||"").trim(); if(!t) continue; const live=document.getElementById('liveTranscript'); if (live && live.style.display==="none") live.style.display="block"; const parts=t.toLowerCase().split(/\s+/); parts.forEach(w=>acceptCandidate(w,false)); const last=parts[parts.length-1]||""; if (live) live.textContent=last.toUpperCase(); } }; r.onerror=_=>{}; r.onend=()=>{ if(state.voice && state.running && state.remaining>0) try{ r.start(); }catch{} }; return r; }
    function enterVoiceMode(){ const live=document.getElementById('liveTranscript'); if (live){ live.textContent=""; live.style.display="none"; } document.getElementById('typeInput').style.display="none"; document.getElementById('modePill').style.display="inline-block"; if(!state.sr) state.sr=ensureSpeech(); if(!state.sr){ showTinyHint("VOICE NOT SUPPORTED"); state.voice=false; return exitVoiceMode(); } state.listening=true; setMicVisual(true); try{ state.sr.start(); }catch{}; }
    function exitVoiceMode(){ document.getElementById('typeInput').style.display="block"; document.getElementById('liveTranscript').style.display="none"; document.getElementById('modePill').style.display="none"; if(state.listening){ state.listening=false; setMicVisual(false); try{ state.sr.stop(); }catch{} } }

    (function wrapFetch(){ const _fetch = window.fetch.bind(window); window.fetch = async (input, init = {}) => { const url = (typeof input === 'string') ? input : (input?.url || ''); const sameOrigin = !/^https?:\/\//i.test(url) || url.startsWith(location.origin); if (sameOrigin) { if (!window.__supabase_token) await (window.syncSupabaseToken?.() || Promise.resolve()); init.headers = new Headers(init.headers || {}); if (window.__supabase_token && !init.headers.has('Authorization')) { init.headers.set('Authorization', 'Bearer ' + window.__supabase_token); } } return _fetch(input, init); }; })();

    async function syncToday(advance=false){ try{ const r=await fetch('/api/today' + (advance ? '?advance=1' : '')); if(!r.ok) return; const d=await r.json(); if(d.letter) document.getElementById('letterBubble').textContent=d.letter.toUpperCase(); if(d.theme) document.getElementById('themeHeading').textContent=d.theme.toUpperCase(); window.__letterBonus = (d.letterBonus|0); window.__roundSeconds  = (d.roundSeconds|0)}catch{} }

    document.getElementById('typeInput').addEventListener("keydown",(e)=>{ if(e.key!=="Enter") return; e.preventDefault(); if (!state.running) { showTinyHint("PRESS START"); return; } const v=e.target.value.trim(); if(!v) return; acceptCandidate(v,true); e.target.value=""; });

    document.getElementById('startBtn').addEventListener("click", async () => {
      const session = await window.ensureAuth({ force: true });
      if (!session) return; // login dialog opened; stop here
      // ensure token is set for /api/submit-run later
      if (session.access_token) window.__supabase_token = session.access_token;
      startRound();
    });

    document.getElementById('finishBtn').addEventListener("click", endRound);

    function ensureAcceptedUI(){ if (startRound._ul) return; const section=document.createElement("section"); section.className="section"; const ul=document.createElement("ul"); ul.className="wordstream"; section.append(ul); document.getElementById('acceptedSectionAnchor').replaceWith(section); startRound._ul=ul; }

    async function acceptCandidate(raw, fromTyping){
      if (!state.running) { if (fromTyping) showTinyHint("PRESS START"); return; }
      const w = String(raw||"").toLowerCase().replace(/[^a-z\u00C0-\u024f'-]/g,""); if (!w) return;
      const dailyLetter = (document.getElementById('letterBubble').textContent||'').toLowerCase();
      if (state.words.has(w)) return fromTyping && showTinyHint("DUPLICATE");
      if (w.length < 3)      return fromTyping && showTinyHint("MIN LENGTH");
      if (!w.startsWith(dailyLetter)) return fromTyping && showTinyHint(`MUST START “${dailyLetter.toUpperCase()}”`);
      let server;
      try { const r = await fetch('/api/check-word',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ word:w })}); server = await r.json(); }
      catch { return fromTyping && showTinyHint("CHECK FAILED"); }
      if (!server?.ok) return fromTyping && showTinyHint("NOT A WORD");
      const strict = (server.theme_mode || '').toLowerCase() === 'strict';
      if (!server.theme_ok) { showTinyHint(`OFF THEME: ${(server.theme||'').toUpperCase()}`); if (strict) return; }
      state.words.add(w); if (server.theme_ok) state.onTheme.add(w); else state.offTheme.add(w);
      ensureAcceptedUI(); const li=document.createElement("li"); if (!server.theme_ok) li.classList.add("off-theme"); li.textContent=w.toUpperCase(); startRound._ul.prepend(li);
    }

    async function syncAndRevealToday(){ await syncToday(true); const s=document.getElementById('todaySection'); if (s && s.style.display==='none') s.style.display='block'; }

    async function startRound(){
      showStartPlaceholder(false);
      await syncAndRevealToday();
      const ti=document.getElementById('typeInput'); ti.placeholder=document.getElementById('letterBubble').textContent; ti.disabled=false; document.getElementById('micMini').disabled=false;
      if(startRound._ul) startRound._ul.innerHTML="";
      state.words.clear(); state.onTheme.clear(); state.offTheme.clear(); state.invalid=0; state.startedAt=Date.now(); state.running=true;
      document.getElementById('finishBtn').style.display="inline-block"; document.getElementById('startBtn').style.display="none"; setTimer(30);
      if(state.voice) enterVoiceMode(); else { exitVoiceMode(); ti.focus(); }
      clearInterval(state.timerId); state.timerId=setInterval(()=>{ state.remaining=Math.max(0,state.remaining-1); document.getElementById("timerMini").textContent=new Date(state.remaining*1000).toISOString().substr(14,5); if(state.remaining<=0) endRound(); },1000);
    }

    function setTimer(secs){ state.remaining=secs; document.getElementById("timerMini").textContent=new Date(secs*1000).toISOString().substr(14,5); }

    async function endRound(){
      clearInterval(state.timerId); state.running=false; document.getElementById('finishBtn').style.display="none"; document.getElementById('startBtn').style.display="inline-block";
      const ti=document.getElementById('typeInput'); ti.disabled=true;
      if(state.listening){ state.listening=false; setMicVisual(false); try{ state.sr.stop(); }catch{} }
      const gameSeconds = Math.max(1, Math.round((Date.now()-(state.startedAt||Date.now()))/1000));
      const letter = document.getElementById('letterBubble').textContent || '—';
      const theme  = document.getElementById('themeHeading').textContent || '—';
      document.getElementById('sumLetter').textContent = letter.toUpperCase();
      document.getElementById('sumTheme').textContent  = theme.toUpperCase();
      document.getElementById('sumValid').textContent  = state.onTheme.size;
      document.getElementById('sumOff').textContent    = state.offTheme.size;
      document.getElementById('sumWords').textContent  = state.words.size;
      document.getElementById('sumDur').textContent    = new Date(gameSeconds*1000).toISOString().substr(14,5);
      document.getElementById('sumBonus').textContent  = '+' + (window.__letterBonus||0);
      document.getElementById('sumScore').textContent  = '…';
      const list = document.getElementById('sumWordList');
      if (list){ list.innerHTML=''; Array.from(state.onTheme).sort().forEach(w=>{const s=document.createElement('span'); s.textContent=w.toUpperCase(); list.appendChild(s);}); Array.from(state.offTheme).sort().forEach(w=>{const s=document.createElement('span'); s.textContent=w.toUpperCase(); s.classList.add('off-theme'); list.appendChild(s);}); }
      document.getElementById('summaryModal').showModal();
      window.__pendingRun = null;
      const payload = { words: Array.from(state.words), inputs: state.words.size + state.invalid, duration: gameSeconds };
      const session = await window.ensureAuth({ force: true });
      if (!session) { window.__pendingRun = payload; return; }
      await submitRun(payload);
    }

    function refreshLeaderboardIfOpen(){ const dlg = document.querySelector('dialog[data-role="leaderboard"]'); if (dlg && window.htmx) htmx.ajax('GET', '/leaderboard', { target: dlg, swap: 'outerHTML' }); }
    async function submitRun(payload){
      try { const resp = await fetch('/api/submit-run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if (!resp.ok) { document.getElementById('sumScore').textContent='—'; return; } const d = await resp.json(); if (typeof d.score === 'number') { document.getElementById('sumScore').textContent = String(d.score); if (typeof d.bonus_per_word === 'number') document.getElementById('sumBonus').textContent = '+' + d.bonus_per_word; } refreshLeaderboardIfOpen(); } catch { document.getElementById('sumScore').textContent='—'; }
    }
  </script>
</div>

{% endblock %}
