<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Vocalist</title>

  <style>
    /* Avoid iOS auto text zoom adjustments */
    html{ -webkit-text-size-adjust:100%; }
    :root{
      --ink:#0f172a; --ink-2:#475569; --muted:#64748b; --accent:#0E7C86; --card:#fff;
      --line:#e7edf3; --shadow:0 20px 60px rgba(2,6,23,.15); --radius:18px;
    }
    body{margin:0;color:var(--ink);background:#fff;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}

    /* Navbar */
    .navbar{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:20}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 0}
    .brand{font-weight:800;letter-spacing:.08em}
    .brand .version{ font-size:10px; font-weight:700; color:var(--muted); margin-left:6px; letter-spacing:.08em }
    .nav-right{display:flex;align-items:center;gap:18px}

    /* Mobile nav */
    #navMenuBtn{display:none}
    @media (max-width:480px){
      .nav-inner{position:relative}
      #navMenuBtn{display:block}
      /* Mobile menu: full-width sidebar below header */
      .nav-right{
        display:none;flex-direction:column;align-items:flex-start;
        position:absolute;top:100%;left:0;transform:none;
        width:100vw;background:#fff;padding:16px 24px;
        border:0;border-radius:0;gap:12px;box-shadow:var(--shadow);
        border-top:1px solid var(--line);
      }
      .nav-right .nav-link{ padding:10px 0; }
      .nav-right.open{display:flex}
    }

    /* Make buttons and spans render identically */
    button.nav-link{font:inherit;}
    .nav-link{
      background:none;border:0;padding:2px 0;cursor:pointer;
      color:var(--ink-2);opacity:.8;font-weight:600;letter-spacing:.06em;
      font-size:14px; line-height:1.2;
    }
    .nav-link:hover{opacity:1}
    .nav-link:focus{outline:none}

    /* Buttons used in page + modals */
    .btn{border:1px solid var(--line);border-radius:12px;padding:10px 16px;background:#fff;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff;border:0}
    .btn-ghost{background:#fff;color:var(--ink-2)}

    /* Dialogs — minimal, calm */
    dialog{border:0;border-radius:24px;box-shadow:var(--shadow);padding:0;background:transparent}
    dialog::backdrop{background:rgba(2,6,23,.35)}
    .modal-card{
      position:relative;background:var(--card);border:1px solid var(--line);
      border-radius:24px;padding:22px 22px 18px;min-width:320px;max-width:720px
    }
    .modal-card h2{margin:0 0 4px;font-size:20px;letter-spacing:.01em}
    .modal-subtle{color:var(--muted);margin:2px 0 10px}
    .modal-divider{height:1px;background:var(--line);margin:10px 0 12px;border:0}
    .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}
    .modal-x{
      position:absolute;top:8px;right:8px;background:transparent;border:0;
      font-size:20px;line-height:1;border-radius:10px;cursor:pointer;opacity:.55;padding:6px
    }
    .modal-x:hover{opacity:1;background:#f8fafc}

    /* Tables / lists inside modals */
    .tbl{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--line);border-radius:14px}
    .tbl th,.tbl td{padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px}
    .tbl th{background:#fbfdff;text-align:left;color:var(--muted);font-weight:700}
    .tbl tr:last-child td{border-bottom:0}
    .ol-plain{margin:8px 0 0 18px}
    .ol-plain li{margin:6px 0}

    /* Utility */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Highlight current user on leaderboard */
    #dlg-leaderboard .tbl tr.me td{ background: rgba(14,124,134,.08); font-weight:700; }

    /* Mobile tweaks */
    @media (max-width: 480px){
      /* Roomier header container padding on mobile */
      .container{ padding-left:20px; padding-right:20px; }
      /* Extra breathing room just for navbar (safe-area aware) */
      .navbar .container{ padding-left:calc(24px + env(safe-area-inset-left)); padding-right:calc(24px + env(safe-area-inset-right)); }
      .nav-inner{ padding:14px 0; }

      /* Match menu sheet padding to navbar for alignment */
      .nav-right{ padding-left:calc(24px + env(safe-area-inset-left)); padding-right:calc(24px + env(safe-area-inset-right)); }

      /* Compact tables on phones to avoid horizontal scroll */
      #dlg-history .tbl{ table-layout: fixed; }
      #dlg-history .tbl th, #dlg-history .tbl td{ padding:8px; font-size:12px; white-space:normal; word-break:break-word; }
      #dlg-history .tbl td:nth-child(2){ font-size:11px; letter-spacing:.02em; font-weight:700; }
      #dlg-leaderboard .tbl{ table-layout: fixed; width:100%; }
      #dlg-leaderboard .tbl th, #dlg-leaderboard .tbl td{ padding:8px; font-size:12px; }
      /* Updated for 3-column layout: Rank | Pts | G */
      #dlg-leaderboard .tbl th:nth-child(1), #dlg-leaderboard .tbl td:nth-child(1){ width:64px; white-space:nowrap; }
      #dlg-leaderboard .tbl th:nth-child(2), #dlg-leaderboard .tbl td:nth-child(2){ width:64px; white-space:nowrap; }
      #dlg-leaderboard .tbl th:nth-child(3), #dlg-leaderboard .tbl td:nth-child(3){ width:64px; white-space:nowrap; }
    }

    /* Center table text in History and Leaderboard */
    #dlg-history .tbl th, #dlg-history .tbl td,
    #dlg-leaderboard .tbl th, #dlg-leaderboard .tbl td{ text-align:center; }
  </style>
</head>

<body
  data-supabase-url="{{ SUPABASE_URL|default('') }}"
  data-supabase-anon="{{ SUPABASE_ANON|default('') }}"
  data-site-url="{{ SITE_URL|default('') }}"
>

  <!-- NAV -->
  <header class="navbar">
    <div class="container nav-inner">
      <div class="brand">Vocalist <span class="version">v{{ VERSION() }}</span></div>
      <button class="nav-link" id="navMenuBtn">Menu</button>
      <nav class="nav-right">
        <button class="nav-link" hx-get="/my-stats"    hx-target="#modalHost" hx-swap="beforeend">Stats</button>
        <button class="nav-link" hx-get="/history"     hx-target="#modalHost" hx-swap="beforeend">History</button>
        <button class="nav-link" hx-get="/leaderboard" hx-target="#modalHost" hx-swap="beforeend">Leaderboard</button>

        <button class="nav-link" id="authLoginBtn">Log in</button>
        <button class="nav-link" id="authLogoutBtn" style="display:none">Log out</button>
        <span   class="nav-link" id="navUser" style="display:none;cursor:default"></span>
      </nav>
    </div>
  </header>

  <!-- PAGE -->
  <main class="container" id="page">
    {% block content %}{% endblock %}
  </main>

  <!-- Host for HTMX-loaded dialogs (only newest opens) -->
  <div id="modalHost"></div>

  <!-- AUTH DIALOG -->
  <dialog id="authDialog">
    <div class="modal-card">
      <form method="dialog"><button class="modal-x" aria-label="Close">×</button></form>
      <h2>Sign in</h2>
      <p class="modal-subtle">We’ll email you a magic link.</p>
      <hr class="modal-divider" />
      <label class="sr-only" for="authEmailInput">Email</label>
      <input id="authEmailInput" type="email" placeholder="you@example.com"
             style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);outline:none;margin-bottom:10px" />
      <div id="authMsg" class="modal-subtle" aria-live="polite"></div>
      <div class="modal-actions">
        <button id="authCloseBtn" class="btn btn-ghost" type="button">Close</button>
        <button id="authSendBtn"  class="btn btn-primary" type="button">Send link</button>
      </div>
    </div>
  </dialog>

  <!-- Scripts -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase bootstrap via data-* from server ===
    const SUPABASE_URL  = document.body.dataset.supabaseUrl || "";
    const SUPABASE_ANON = document.body.dataset.supabaseAnon || "";
    const SITE_URL_HINT = document.body.dataset.siteUrl || ""; // e.g. https://vocalist-xxxx.onrender.com

    function haveKeys(){ return !!(SUPABASE_URL && SUPABASE_ANON); }
    function initSB(){
      if (!haveKeys()) return null;
      if (!window.sb || !window.sb.auth || !String(window.sb?.supabaseUrl).startsWith(SUPABASE_URL)) {
        window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      }
      return window.sb;
    }
    initSB();

    async function getSessionSafe(){
      const sb = initSB();
      if (!sb?.auth) return null;
      const { data:{ session } } = await sb.auth.getSession();
      return session || null;
    }
    async function syncSupabaseToken(){
      const session = await getSessionSafe();
      window.__supabase_token = session?.access_token || null;
      toggleAuthUI(!!session, session?.user);
      updateHxAuthHeaders(); // keep hx-headers in sync with token
    }
    function toggleAuthUI(authed, user){
      const loginBtn  = document.getElementById('authLoginBtn');
      const logoutBtn = document.getElementById('authLogoutBtn');
      const userEl    = document.getElementById('navUser');
      if (loginBtn)  loginBtn.style.display  = authed ? 'none' : '';
      if (logoutBtn) logoutBtn.style.display = authed ? '' : 'none';
      if (userEl) {
        // Privacy: never show any user-identifying text in the navbar
        userEl.style.display = 'none';
        userEl.textContent = '';
      }
    }

    // Initial sync (don’t await here)
    syncSupabaseToken();
    // React to auth changes
    window.sb?.auth?.onAuthStateChange((_evt, session) => {
      window.__supabase_token = session?.access_token || null;
      toggleAuthUI(!!session, session?.user);
      updateHxAuthHeaders();
    });

    // === HTMX auth header (synchronous) ===
    document.body.addEventListener('htmx:configRequest', (evt) => {
      const t = window.__supabase_token;
      if (t) evt.detail.headers['Authorization'] = 'Bearer ' + t;
    });

    // Keep hx-headers set on nav buttons (so token travels with click)
    function updateHxAuthHeaders() {
      const t = window.__supabase_token;
      const hdr = t ? JSON.stringify({ Authorization: 'Bearer ' + t }) : null;
      document.querySelectorAll('button.nav-link[hx-get]').forEach(btn => {
        if (hdr) btn.setAttribute('hx-headers', hdr);
        else btn.removeAttribute('hx-headers');
      });
    }
    // Gate clicks when not signed in: show login dialog instead of sending a 401
    function requireAuthFor(selector) {
      const el = document.querySelector(selector);
      if (!el) return;
      el.addEventListener('click', async (e) => {
        const session = await getSessionSafe();
        if (!session) {
          e.preventDefault(); e.stopPropagation();
          document.getElementById('authDialog')?.showModal();
        }
      }, { capture: true });
    }
    requireAuthFor('button.nav-link[hx-get="/my-stats"]');
    requireAuthFor('button.nav-link[hx-get="/history"]');
    requireAuthFor('button.nav-link[hx-get="/leaderboard"]');

    // Mobile nav toggle
    document.getElementById('navMenuBtn')?.addEventListener('click', () => {
      document.querySelector('.nav-right')?.classList.toggle('open');
    });

    // Only open the newly inserted dialog in #modalHost; remove on close
    const modalHost = document.getElementById('modalHost');
    document.body.addEventListener('htmx:afterSwap', (evt) => {
      if (evt.detail.target !== modalHost) return;
      const dlg = modalHost.lastElementChild;
      if (dlg && dlg.nodeName === 'DIALOG' && dlg.hasAttribute('data-autoshow')) {
        try { dlg.showModal(); } catch {}
      }
    });
    modalHost.addEventListener('close', (e) => {
      const dlg = e.target;
      if (dlg?.nodeName === 'DIALOG') dlg.remove();
    }, true);

    // Login / Logout
    document.getElementById('authLoginBtn')?.addEventListener('click', () => {
      document.getElementById('authDialog')?.showModal();
    });
    document.getElementById('authCloseBtn')?.addEventListener('click', () => {
      document.getElementById('authDialog')?.close();
    });
    document.getElementById('authSendBtn')?.addEventListener('click', async () => {
      const emailEl = document.getElementById('authEmailInput');
      const msgEl   = document.getElementById('authMsg');
      const email   = (emailEl.value || '').trim();

      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        msgEl.textContent = 'Please enter a valid email.'; emailEl.focus(); return;
      }
      if (!haveKeys()){
        msgEl.textContent = 'Auth not configured (server didn’t pass SUPABASE_URL/ANON).';
        return;
      }
      msgEl.textContent = 'Sending…';
      document.getElementById('authSendBtn').disabled = true;

      const redirectTo = SITE_URL_HINT || window.location.origin;
      try{
        const sb = initSB();
        const { error } = await sb.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: redirectTo }
        });
        msgEl.textContent = error ? ('Error: ' + error.message) : 'Check your inbox for the magic link.';
      }catch(e){
        msgEl.textContent = 'Error: ' + (e?.message || 'unknown');
      }finally{
        document.getElementById('authSendBtn').disabled = false;
      }
    });

    document.getElementById('authLogoutBtn')?.addEventListener('click', async () => {
      try { const sb = initSB(); await sb?.auth?.signOut(); } finally { window.__supabase_token = null; toggleAuthUI(false, null); updateHxAuthHeaders(); }
    });

    // Optional: same-origin fetch wrapper (adds Authorization automatically)
    (function wrapFetch(){
      const _fetch = window.fetch.bind(window);
      window.fetch = async (input, init = {}) => {
        const url = (typeof input === 'string') ? input : (input?.url || '');
        const sameOrigin = !/^https?:\/\//i.test(url) || url.startsWith(location.origin);
        if (sameOrigin) {
          init.headers = new Headers(init.headers || {});
          if (window.__supabase_token && !init.headers.has('Authorization')) {
            init.headers.set('Authorization', 'Bearer ' + window.__supabase_token);
          }
        }
        return _fetch(input, init);
      };
    })();
  </script>

  {% block extra_scripts %}{% endblock %}
</body>
</html>
